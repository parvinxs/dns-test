<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="h1Title">üöÄ ÿ™ÿ≥ÿ™ ÿ≤ŸÜÿØŸá DNS Ÿà ÿ≥ŸÜÿ¨ÿ¥ ÿ≥ÿ±ÿπÿ™</title>
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/e/e0/Rocket_icon.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&family=Roboto:wght=400;700&display=swap" rel="stylesheet">
    <style>
        /* =================================================================
           BASE STYLES & VARIABLES
           ================================================================= */
        :root {
            --color-primary: #3b82f6; /* Blue */
            --color-secondary: #10b981; /* Emerald/Green */
            --color-accent: #f59e0b; /* Amber/Yellow */
            --color-background: #f3f4f6; /* Light Gray */
            --color-card-bg: #ffffff; /* White */
            --color-text: #1f2937; /* Dark Gray */
            --color-light-text: #6b7280; /* Medium Gray */
            --color-border: #e5e7eb;
            --color-shadow: rgba(0, 0, 0, 0.05);
            --font-size-base: 16px;
        }

        /* Reset and Base Typography */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            padding: 20px;
            direction: rtl; /* Default to Persian (RTL) */
            transition: all 0.3s;
        }

        body.rtl-mode {
            direction: rtl;
        }

        body[lang="en"] {
            font-family: 'Roboto', sans-serif;
            direction: ltr;
        }
        
        /* Containers and Layout */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background-color: var(--color-card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--color-shadow);
            padding: 25px;
            margin-bottom: 25px;
            transition: box-shadow 0.3s;
        }
        
        .card:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        /* Headings */
        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
        }

        h1 {
            color: var(--color-primary);
            font-size: 2.2rem;
        }

        h2 {
            color: var(--color-text);
            font-size: 1.6rem;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-border);
        }

        /* Buttons */
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s, transform 0.1s;
            margin: 5px;
            white-space: nowrap;
        }

        button:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .primary-btn {
            background-color: var(--color-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .copy-btn {
            background-color: var(--color-light-text);
            color: white;
            padding: 5px 10px;
            margin: 0;
            font-size: 0.8rem;
        }

        #languageToggle {
            background-color: var(--color-accent);
            color: white;
            font-size: 0.9rem;
        }

        /* IP Section */
        #ipSection {
            text-align: center;
            padding: 15px;
            background-color: #e0f2fe; /* Light Blue BG */
            border-radius: 8px;
            margin-bottom: 25px;
            color: #0369a1; /* Darker Blue Text */
        }

        #ipInitialState {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #ipInitialState span {
            margin-bottom: 15px;
            font-weight: 400;
            font-size: 1.1rem;
        }

        #ipContent {
            display: none; /* Initially hidden */
            flex-direction: column;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .ip-info-line {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .ip-info-line span {
            font-weight: 400;
            margin: 0 5px;
            color: var(--color-text);
        }
        
        .flag-icon {
            width: 25px;
            height: auto;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        /* DNS Table */
        #dnsTester {
            overflow-x: auto;
        }

        #dnsTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            min-width: 600px;
        }

        #dnsTable th, #dnsTable td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid var(--color-border);
        }

        #dnsTable thead th {
            background-color: var(--color-background);
            color: var(--color-text);
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        #dnsTable tbody tr:hover {
            background-color: #f7f7f7;
        }

        #dnsTable td:first-child, #dnsTable th:first-child {
            border-radius: 0 8px 0 0; /* Adjust for RTL/LTR */
        }
        
        /* LTR adjustments */
        body[dir="ltr"] #dnsTable td:first-child, body[dir="ltr"] #dnsTable th:first-child {
            border-radius: 8px 0 0 0;
        }

        body[dir="rtl"] #dnsTable td:first-child, body[dir="rtl"] #dnsTable th:first-child {
            border-radius: 0 8px 0 0;
        }

        .dns-ip-cell-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .dns-ips {
            line-height: 1.2;
        }

        .single-ip {
            display: block;
            font-size: 0.9rem;
            color: var(--color-light-text);
        }

        /* Status and Speed Indicators */
        #dnsTable td span {
            font-weight: 700;
        }
        
        #bestDNS {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            background-color: #fffbeb;
            border-radius: 8px;
            color: var(--color-accent);
        }

        .fastest {
            background-color: #ecfdf5 !important; /* Light green highlight */
            border: 2px solid var(--color-secondary);
        }

        /* Speed Bar Styling */
        .speed-bar-container {
            height: 8px;
            width: 100%;
            background-color: var(--color-border);
            border-radius: 4px;
            margin: 5px auto;
            overflow: hidden;
        }
        
        .speed-bar {
            height: 100%;
            width: 0;
            background-color: var(--color-primary);
            transition: width 0.5s, background-color 0.5s;
        }
        
        .speed-text {
            display: block;
            font-size: 0.9rem;
            color: var(--color-light-text);
        }
        
        /* Loader Animation */
        .loader {
            border: 4px solid var(--color-border);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-inline-end: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes loadingEffect {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        /* Global Speed Test Section */
        #speedTestSection {
            text-align: center;
        }

        .speed-display {
            font-size: 3rem;
            font-weight: 700;
            margin: 15px 0;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .speed-unit {
            font-size: 1.5rem;
            color: var(--color-light-text);
            align-self: flex-end;
        }

        #speedStatus {
            font-style: italic;
            color: var(--color-light-text);
            margin-bottom: 15px;
            min-height: 20px;
        }
        
        /* Button Loader for Speed Test */
        #speedTestBtn {
            min-width: 250px;
            height: 45px;
        }

        #buttonLoader {
            display: none;
            margin-inline-start: 10px;
        }

        /* Footer/Creator Info */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 15px;
            border-top: 1px solid var(--color-border);
            font-size: 0.9rem;
            color: var(--color-light-text);
        }

        .footer a {
            color: var(--color-primary);
            text-decoration: none;
        }

        /* =================================================================
           RESPONSIVE DESIGN (Mobile First)
           ================================================================= */

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            h2 {
                font-size: 1.4rem;
            }

            .card {
                padding: 15px;
            }

            button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            /* DNS Table - Mobile view */
            #dnsTable thead {
                display: none; /* Hide headers */
            }

            #dnsTable, #dnsTable tbody, #dnsTable tr, #dnsTable td {
                display: block;
                width: 100%;
            }

            #dnsTable tr {
                margin-bottom: 15px;
                border: 1px solid var(--color-border);
                border-radius: 8px;
                display: flex;
                flex-direction: column;
            }

            #dnsTable td {
                text-align: start;
                border-bottom: 1px dotted var(--color-border);
                padding: 10px 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            #dnsTable tr:last-child {
                border-bottom: none;
            }

            #dnsTable td:before {
                /* Data-label is the column name */
                content: attr(data-label);
                font-weight: 700;
                margin-inline-end: 15px;
                color: var(--color-text);
            }
            
            /* Specific alignment for speed bar */
            #dnsTable td:nth-child(6) { /* Speed column */
                flex-direction: column;
                align-items: flex-start;
            }
            
            #dnsTable td:nth-child(6) .speed-bar-container {
                width: 90%;
            }

            #dnsTable td:last-child {
                border-bottom: none;
            }
            
            .dns-ip-cell-content {
                align-items: flex-end;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1 data-i18n="h1Title">üöÄ ÿ™ÿ≥ÿ™ ÿ≤ŸÜÿØŸá DNS Ÿà ÿ≥ŸÜÿ¨ÿ¥ ÿ≥ÿ±ÿπÿ™</h1>
        </header>

        <section id="ipSection" class="card">
            <div id="ipInitialState">
                <span data-i18n="ipClickToReveal">ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ IP ÿπŸÖŸàŸÖ€å ⁄©ŸÑ€å⁄© ⁄©ŸÜ€åÿØ</span>
                <button id="revealIpBtn" class="primary-btn" onclick="revealPublicIP()">
                    <span data-i18n="revealIpBtnText">ŸÜŸÖÿß€åÿ¥ IP</span>
                </button>
                 <button id="languageToggle" onclick="switchLanguage()" style="margin-top: 10px;"></button>
            </div>
            <div id="ipContent" style="display: none;">
                </div>
        </section>

        <section id="dnsTester" class="card">
            <h2 data-i18n="h2Dns">‚è∞ ÿ≥ŸÜÿ¨ÿ¥ ÿ≤ŸÖÿßŸÜ Ÿæÿßÿ≥ÿÆ⁄ØŸà€å€å DNS</h2>

            <div style="text-align: center; margin-bottom: 15px;">
                <button id="startBtn" class="primary-btn" data-i18n="startDnsBtn">
                    ÿ¥ÿ±Ÿàÿπ ÿ™ÿ≥ÿ™ DNS ‚ö°Ô∏è
                </button>
            </div>
            
            <div id="bestDNS"></div>

            <div style="overflow-x: auto;">
                <table id="dnsTable">
                    <thead>
                        <tr>
                            <th data-i18n="thPriority">ÿßŸàŸÑŸà€åÿ™</th>
                            <th data-i18n="thName">ŸÜÿßŸÖ DNS</th>
                            <th data-i18n="thIP">IP ÿ≥ÿ±Ÿàÿ± DNS</th> 
                            <th data-i18n="thDomain">ÿØÿßŸÖŸÜŸá</th>
                            <th data-i18n="thStatus">Ÿàÿ∂ÿπ€åÿ™</th>
                            <th data-i18n="thSpeed">ÿ≥ÿ±ÿπÿ™ (ms)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" data-i18n="statusReady">ÿ¢ŸÖÿßÿØŸá ÿ®ÿ±ÿß€å ÿ™ÿ≥ÿ™</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="speedTestSection" class="card">
            <h2 data-i18n="h2Speed">üì° ÿ™ÿ≥ÿ™ ÿ≥ÿ±ÿπÿ™ ÿØÿßŸÜŸÑŸàÿØ ÿßÿ™ÿµÿßŸÑ ÿ¨ŸáÿßŸÜ€å</h2>
            
            <div id="speedBarContainer" class="speed-bar-container" style="height: 15px;">
                <div id="speedBar" class="speed-bar"></div>
            </div>

            <p id="speedStatus" data-i18n="statusReady" style="margin: 10px 0;">ÿ¢ŸÖÿßÿØŸá ÿ®ÿ±ÿß€å ÿ™ÿ≥ÿ™</p>

            <div class="speed-display">
                <span id="downloadSpeedDisplay">--</span> 
                <span class="speed-unit">Mbps</span>
            </div>

            <button id="speedTestBtn" class="primary-btn">
                <span id="buttonText" data-i18n="startSpeedBtn">ÿ¥ÿ±Ÿàÿπ ÿ™ÿ≥ÿ™ ÿ≥ÿ±ÿπÿ™ (ŸÅŸÇÿ∑ ÿØÿßŸÜŸÑŸàÿØ) üåê</span>
                <div id="buttonLoader" class="loader"></div>
            </button>
        </section>

        <footer class="footer">
            <p data-i18n="creatorText">ÿ≥ÿßÿÆÿ™Ÿá ÿ¥ÿØŸá ÿ™Ÿàÿ≥ÿ∑ <strong>XSParvin</strong> | <a href="https://t.me/xsfsociety" target="_blank" rel="noopener noreferrer">⁄©ÿßŸÜÿßŸÑ ÿ™ŸÑ⁄Øÿ±ÿßŸÖ</a></p>
        </footer>

    </div>

    <script>
        // --- Language Data (i18n) ---
        const langData = {
            en: {
                // Global
                currentLang: 'en',
                font: 'Roboto',
                toggleBtn: 'ŸÅÿßÿ±ÿ≥€å üîÑ English',
                // HTML Text
                creatorText: 'Created by <strong>XSParvin</strong> | <a href="https://t.me/xsfsociety" target="_blank" rel="noopener noreferrer">Telegram Channel</a>',
                h1Title: '‚ö°Ô∏è Live DNS Tester & Speed Test',
                ipClickToReveal: 'Click to Reveal Public IP', 
                revealIpBtnText: 'Reveal IP', 
                ipFetching: 'Fetching your Public IP and Geo-location...', 
                publicIpLabel: 'Public IP:',
                countryLabel: 'Country:', 
                copyIpBtn: 'Copy IP',
                h2Dns: '‚è∞ DNS Response Time Tester',
                startDnsBtn: 'üöÄ Start DNS Test',
                thPriority: 'Priority',
                thName: 'DNS Name',
                thIP: 'DNS IP', // NEW KEY
                thDomain: 'Domain',
                thStatus: 'Status',
                thSpeed: 'Speed (ms)',
                loaderDns: 'Starting tests...',
                h2Speed: 'üì° Global Connection Download Speed Test',
                statusReady: 'Ready to test',
                speedLabelDownload: 'Download',
                startSpeedBtn: 'Start Speed Test (Download Only) üåê',
                rerunSpeedBtn: 'Re-run Download Test üåê',
                buttonTesting: 'Testing...',

                // JS Strings
                copyAlert1: 'Copied!',
                copyAlert2: 'Failed to copy IP. Please copy manually.',
                testDnsStatus: 'Testing',
                downloadStatus1: 'Connecting to',
                downloadStatus2: 'Live Speed:',
                downloadError: 'Download Error! Try again.',
                speedStatusStart: 'Starting Download Test...',
                downloadResult1: 'Download:',
                downloadResult2: 'Test Complete!',
                downloadFail: 'FAIL',
                dnsFail: 'Failed',
                dnsSuccess: 'OK',
                dnsAvg: '(Avg of',
                dnsFailedText: '(Failed)',
                fastestDns: 'üèÜ Fastest DNS:',
                allDnsFail: 'üòî All DNS tests failed or timed out. Try again.',
                generalError: 'An unexpected error occurred during the test.',
                unknownCountry: 'Unknown',
                copyDnsBtn: 'Copy IPs' // NEW KEY
            },
            fa: {
                // Global
                currentLang: 'fa',
                font: 'Vazirmatn',
                toggleBtn: 'English üîÑ ŸÅÿßÿ±ÿ≥€å',
                // HTML Text
                creatorText: 'ÿ≥ÿßÿÆÿ™Ÿá ÿ¥ÿØŸá ÿ™Ÿàÿ≥ÿ∑ <strong>XSParvin</strong> | <a href="https://t.me/xsfsociety" target="_blank" rel="noopener noreferrer">⁄©ÿßŸÜÿßŸÑ ÿ™ŸÑ⁄Øÿ±ÿßŸÖ</a>',
                h1Title: 'üöÄ ÿ™ÿ≥ÿ™ ÿ≤ŸÜÿØŸá DNS Ÿà ÿ≥ŸÜÿ¨ÿ¥ ÿ≥ÿ±ÿπÿ™',
                ipClickToReveal: 'ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ IP ÿπŸÖŸàŸÖ€å ⁄©ŸÑ€å⁄© ⁄©ŸÜ€åÿØ', 
                revealIpBtnText: 'ŸÜŸÖÿß€åÿ¥ IP', 
                ipFetching: '...ÿØÿ± ÿ≠ÿßŸÑ ÿØÿ±€åÿßŸÅÿ™ IP ÿπŸÖŸàŸÖ€å Ÿà ŸÖŸàŸÇÿπ€åÿ™ ÿ¨ÿ∫ÿ±ÿßŸÅ€åÿß€å€å ÿ¥ŸÖÿß', 
                publicIpLabel: 'IP ÿπŸÖŸàŸÖ€å:',
                countryLabel: '⁄©ÿ¥Ÿàÿ±:', 
                copyIpBtn: '⁄©Ÿæ€å IP',
                h2Dns: '‚è∞ ÿ≥ŸÜÿ¨ÿ¥ ÿ≤ŸÖÿßŸÜ Ÿæÿßÿ≥ÿÆ⁄ØŸà€å€å DNS',
                startDnsBtn: 'ÿ¥ÿ±Ÿàÿπ ÿ™ÿ≥ÿ™ DNS ‚ö°Ô∏è',
                thPriority: 'ÿßŸàŸÑŸà€åÿ™',
                thName: 'ŸÜÿßŸÖ DNS',
                thIP: 'IP ÿ≥ÿ±Ÿàÿ± DNS', // NEW KEY
                thDomain: 'ÿØÿßŸÖŸÜŸá',
                thStatus: 'Ÿàÿ∂ÿπ€åÿ™',
                thSpeed: 'ÿ≥ÿ±ÿπÿ™ (ms)',
                loaderDns: 'ÿØÿ± ÿ≠ÿßŸÑ ÿ¥ÿ±Ÿàÿπ ÿ™ÿ≥ÿ™‚ÄåŸáÿß...',
                h2Speed: 'üì° ÿ™ÿ≥ÿ™ ÿ≥ÿ±ÿπÿ™ ÿØÿßŸÜŸÑŸàÿØ ÿßÿ™ÿµÿßŸÑ ÿ¨ŸáÿßŸÜ€å',
                statusReady: 'ÿ¢ŸÖÿßÿØŸá ÿ®ÿ±ÿß€å ÿ™ÿ≥ÿ™',
                speedLabelDownload: 'ÿØÿßŸÜŸÑŸàÿØ',
                startSpeedBtn: 'ÿ¥ÿ±Ÿàÿπ ÿ™ÿ≥ÿ™ ÿ≥ÿ±ÿπÿ™ (ŸÅŸÇÿ∑ ÿØÿßŸÜŸÑŸàÿØ) üåê',
                rerunSpeedBtn: 'ÿßÿ¨ÿ±ÿß€å ŸÖÿ¨ÿØÿØ ÿ™ÿ≥ÿ™ ÿØÿßŸÜŸÑŸàÿØ üåê',
                buttonTesting: 'ÿØÿ± ÿ≠ÿßŸÑ ÿ™ÿ≥ÿ™...',

                // JS Strings
                copyAlert1: '⁄©Ÿæ€å ÿ¥ÿØ!',
                copyAlert2: '⁄©Ÿæ€å IP ÿßŸÜÿ¨ÿßŸÖ ŸÜÿ¥ÿØ. ŸÑÿ∑ŸÅÿßŸã ÿ®Ÿá ÿµŸàÿ±ÿ™ ÿØÿ≥ÿ™€å ⁄©Ÿæ€å ⁄©ŸÜ€åÿØ.',
                testDnsStatus: 'ÿØÿ± ÿ≠ÿßŸÑ ÿ™ÿ≥ÿ™',
                downloadStatus1: 'ÿØÿ± ÿ≠ÿßŸÑ ÿßÿ™ÿµÿßŸÑ ÿ®Ÿá',
                downloadStatus2: 'ÿ≥ÿ±ÿπÿ™ ÿ≤ŸÜÿØŸá:',
                downloadError: 'ÿÆÿ∑ÿß ÿØÿ± ÿØÿßŸÜŸÑŸàÿØ! ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.',
                speedStatusStart: 'ÿØÿ± ÿ≠ÿßŸÑ ÿ¥ÿ±Ÿàÿπ ÿ™ÿ≥ÿ™ ÿØÿßŸÜŸÑŸàÿØ...',
                downloadResult1: 'ÿØÿßŸÜŸÑŸàÿØ:',
                downloadResult2: 'ÿ™ÿ≥ÿ™ ⁄©ÿßŸÖŸÑ ÿ¥ÿØ!',
                downloadFail: 'ÿÆÿ∑ÿß',
                dnsFail: 'ŸÜÿßŸÖŸàŸÅŸÇ',
                dnsSuccess: 'ŸÖŸàŸÅŸÇ',
                dnsAvg: '(ŸÖ€åÿßŸÜ⁄Ø€åŸÜ',
                dnsFailedText: '(ŸÜÿßŸÖŸàŸÅŸÇ)',
                fastestDns: 'üèÜ ÿ≥ÿ±€åÿπ‚Äåÿ™ÿ±€åŸÜ DNS:',
                allDnsFail: 'üòî ÿ™ŸÖÿßŸÖ€å ÿ™ÿ≥ÿ™‚ÄåŸáÿß€å DNS ŸÜÿßŸÖŸàŸÅŸÇ ÿ®ŸàÿØŸÜÿØ €åÿß ÿ®Ÿá Ÿæÿß€åÿßŸÜ ÿ±ÿ≥€åÿØŸÜÿØ. ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.',
                generalError: '€å⁄© ÿÆÿ∑ÿß€å ÿ∫€åÿ±ŸÖŸÜÿ™ÿ∏ÿ±Ÿá ÿØÿ± ÿ∑ŸàŸÑ ÿ™ÿ≥ÿ™ ÿ±ÿÆ ÿØÿßÿØ.',
                unknownCountry: 'ŸÜÿßŸÖÿ¥ÿÆÿµ',
                copyDnsBtn: '⁄©Ÿæ€å IPŸáÿß' // NEW KEY
            }
        };

        let currentLang = 'fa'; // Default language set to Persian
        let ipData = { publicIP: null, countryCode: null, countryName: null }; // Cache for IP data 

        /**
         * Updates the text content of elements based on the current language setting.
         */
        function updateDOMText() {
            const lang = langData[currentLang];
            document.documentElement.lang = lang.currentLang;
            document.documentElement.dir = (currentLang === 'fa' ? 'rtl' : 'ltr');
            document.body.style.fontFamily = `'${lang.font}', sans-serif`;
            document.body.classList.toggle('rtl-mode', currentLang === 'fa');

            // Update i18n marked elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (lang[key]) {
                    if (key === 'creatorText') {
                        el.innerHTML = lang[key];
                    } else {
                        el.textContent = lang[key];
                    }
                }
            });

            // Handle the language toggle button which is re-created
            const ipContentDiv = document.getElementById('ipContent');
            const ipInitialStateDiv = document.getElementById('ipInitialState');

            if (ipContentDiv && ipContentDiv.style.display !== 'none') {
                const toggleButton = ipContentDiv.querySelector('#languageToggle');
                if (toggleButton) {
                    toggleButton.textContent = lang.toggleBtn;
                }

                if (ipData.publicIP) {
                    displayPublicIP(ipData.publicIP, ipData.countryName, ipData.countryCode);
                }

            } else if (ipInitialStateDiv) {
                const toggleButton = ipInitialStateDiv.querySelector('#languageToggle');
                if (toggleButton) {
                    toggleButton.textContent = lang.toggleBtn;
                }
            }


            // Update data-label for responsive tables (headers)
            document.querySelectorAll('#dnsTable thead th').forEach(th => {
                const key = th.getAttribute('data-i18n');
                const correspondingFaKey = langData.fa[key];
                const correspondingEnKey = langData.en[key];

                document.querySelectorAll(`#dnsTable tbody td`).forEach(td => {
                    // Check if the current data-label matches the key from either language
                    if (td.getAttribute('data-label') === correspondingFaKey || td.getAttribute('data-label') === correspondingEnKey) {
                         td.setAttribute('data-label', lang[key]);
                    }
                });
            });
        }

        /**
         * Toggles the application language between English and Persian.
         */
        window.switchLanguage = function() {
            currentLang = (currentLang === 'en' ? 'fa' : 'en');
            updateDOMText();
        }


        // --- Advanced Speed Test Settings ---
        const TEST_COUNT = 5; 
        const MAX_TIMEOUT = 6000; 
        const DOWNLOAD_SIZE_BYTES = 10485760; // 10MB (10 * 1024 * 1024)

        const DOWNLOAD_URLS = [
            'https://speed.cloudflare.com/__down?bytes=' + DOWNLOAD_SIZE_BYTES,
            'https://ipv4.download.thinkbroadband.com/10MB.zip' 
        ];

        // DNS Servers to test 
        // IPs are grouped for combined display
        const dnsServers = [
          {name:"Shecan", urls:["https://shecan.ir/favicon.ico", "https://shecan.ir/logo.svg"], domain:"shecan.ir", ips:["178.22.122.100", "178.22.122.101"]}, 
          {name:"Google", urls:["https://www.google.com/images/cleardot.gif"], domain:"google.com", ips:["8.8.8.8", "8.8.4.4"]},
          {name:"Cloudflare", urls:["https://cloudflare.com/cdn-cgi/images/icon-logo.svg"], domain:"cloudflare.com", ips:["1.1.1.1", "1.0.0.1"]},
          {name:"Quad9", urls:["https://www.quad9.net/favicon.com"], domain:"quad9.net", ips:["9.9.9.9"]},
          {name:"Level 3", urls:["https://www.level3.com/favicon.ico"], domain:"level3.com", ips:["209.244.0.3"]},
        ];

        function getColor(speed){
          if(speed<100) return "var(--color-secondary)"; 
          if(speed<200) return "var(--color-primary)"; 
          if(speed<400) return "var(--color-accent)"; 
          return "#f87171"; 
        }

        function getSpeedColor(speedMbps){
            if (speedMbps >= 20) return "var(--color-secondary)"; 
            if (speedMbps >= 5) return "var(--color-accent)"; 
            return "#f87171"; 
        }

        /**
         * Executes a fetch request with a defined timeout.
         */
        function fetchWithTimeout(url, timeout=MAX_TIMEOUT){
          return new Promise(resolve=>{
            const start = performance.now();
            const urlWithCacheBuster = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now(); 
            const controller = new AbortController();
            const signal = controller.signal;

            const timer = setTimeout(()=>{
                controller.abort(); 
                resolve(timeout);
            }, timeout);

            fetch(urlWithCacheBuster, {
                mode:'no-cors', 
                cache:'no-store', 
                signal: signal 
            })
              .then(()=>{ 
                  clearTimeout(timer); 
                  resolve(performance.now()-start); 
              })
              .catch(error=>{ 
                  clearTimeout(timer); 
                  if(error.name === 'AbortError') {
                      resolve(timeout); 
                  } else {
                      console.warn(`Fetch error for ${url}:`, error.message);
                      resolve(timeout);
                  }
              });
          });
        }

        /**
         * Tests a DNS provider by iterating through all its associated URLs.
         */
        async function testDNSProvider(urls, statusElement){
          const lang = langData[currentLang];
          const results = [];

          for(let i=0;i<TEST_COUNT;i++){
            statusElement.textContent = `${lang.testDnsStatus} (${i + 1}/${TEST_COUNT})...`; 

            try {
                // Test ALL URLs (Shecan has two) to get the best result from the group
                const times = await Promise.all(urls.map(url=>fetchWithTimeout(url, MAX_TIMEOUT)));
                const fastest = Math.min(...times);
                if(fastest < MAX_TIMEOUT) results.push(fastest);
            } catch (e) {
                console.warn(`Fetch attempt failed in round ${i+1}. Treating as timeout.`);
            }

            await new Promise(r=>setTimeout(r,50)); 
          }

          // Return the average time of successful attempts, or MAX_TIMEOUT if none succeeded
          return results.length ? results.reduce((a,b)=>a+b,0)/results.length : MAX_TIMEOUT;
        }


        /**
         * Copies text (IP or IPs) to clipboard.
         */
        window.copyToClipboard = function(text){
            const lang = langData[currentLang];
            // Check if the text looks like an IP or a list of IPs
            const isIpLike = text.split(',').every(ip => ip.trim().match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/));
            
            const message = isIpLike
                ? `IP(s): ${text} ${lang.copyAlert1}` 
                : `${lang.copyAlert1}`;

          navigator.clipboard.writeText(text).then(()=>{
            alert(message);
            console.log(`Copied: ${text}`);
          }).catch(err => {
            console.error('Could not copy text: ', err);
            alert(`${lang.copyAlert2}`);
          });
        }

        /**
         * Displays the fetched IP and Geo-location data.
         */
        function displayPublicIP(publicIP, countryName, countryCode) {
            const lang = langData[currentLang];
            const ipContentElement = document.getElementById("ipContent");

            let flagHtml = '';
            let countryDisplay = countryName || lang.unknownCountry; 

            if (countryCode && countryCode.length === 2) {
                let flagUrl = `https://flagcdn.com/w40/${countryCode.toLowerCase()}.png`;
                let flagAlt = `${countryDisplay} Flag`;
                flagHtml = `<img src="${flagUrl}" class="flag-icon" alt="${flagAlt}" title="${countryDisplay}">`;
            }

            // Insert the IP and copy button into the ipContent div
            ipContentElement.innerHTML = `
                <div class="ip-info-line">
                    ${lang.publicIpLabel} <span>${publicIP}</span> 
                    <button class="copy-btn" onclick="copyToClipboard('${publicIP}')">${lang.copyIpBtn}</button>
                </div>
                <div class="ip-info-line">
                    ${flagHtml} 
                    ${lang.countryLabel} <span>${countryDisplay}</span>
                </div>
                <button id="languageToggle" onclick="switchLanguage()">${lang.toggleBtn}</button>
            `;

            // Show the IP content and hide the initial state
            document.getElementById("ipInitialState").style.display = 'none';
            ipContentElement.style.display = 'flex';

            // Ensure the new toggle button gets the correct language setting
            updateDOMText();
        }

        /**
         * Fetches Public IP and Geo-location data upon user click.
         */
        window.revealPublicIP = async function() {
            const lang = langData[currentLang];
            const btn = document.getElementById('revealIpBtn');
            const initialStateDiv = document.getElementById("ipInitialState");
            const ipStatusSpan = initialStateDiv.querySelector('[data-i18n="ipClickToReveal"]');

            if (ipData.publicIP) {
                displayPublicIP(ipData.publicIP, ipData.countryName, ipData.countryCode);
                return;
            }

            btn.disabled = true;
            ipStatusSpan.textContent = lang.ipFetching; 

            let publicIP = null;
            let countryCode = null;
            let countryName = null;

            try {
                // 1. Get Public IP
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                if (!ipResponse.ok) throw new Error('IP service 1 response was not ok');
                publicIP = (await ipResponse.json()).ip;

                // 2. Get Country Code and Name
                const geoResponse = await fetch(`https://ip-api.com/json/${publicIP}?fields=countryCode,country,status`);
                if (geoResponse.ok) {
                    const geoData = await geoResponse.json();
                    if (geoData.status === 'success') {
                        countryCode = geoData.countryCode; 
                        countryName = geoData.country; 
                    }
                }
            } catch (error) {
                console.error("IP or Geo fetch failed:", error);
                ipStatusSpan.textContent = `Error: ${lang.generalError}`;
                btn.disabled = false;
                return;
            }

            // Cache and Display Result
            ipData.publicIP = publicIP;
            ipData.countryCode = countryCode;
            ipData.countryName = countryName; 
            displayPublicIP(publicIP, countryName, countryCode); 
            btn.disabled = false;
        }


        // --- Download Test Function (Code unchanged as logic is robust) ---
        async function downloadSpeedTest(){
            const lang = langData[currentLang];
            const barElement = document.getElementById("speedBar");
            const statusElement = document.getElementById("speedStatus");
            const url = DOWNLOAD_URLS[Math.floor(Math.random() * DOWNLOAD_URLS.length)];

            barElement.style.width = '0%';
            barElement.style.background = 'linear-gradient(90deg, var(--color-primary), var(--color-secondary), var(--color-primary))'; 
            barElement.style.animation = 'loadingEffect 1.5s linear infinite';

            const startOverall = performance.now();
            let receivedLength = 0; 
            const totalLength = DOWNLOAD_SIZE_BYTES; 

            statusElement.innerHTML = `0% ${lang.downloadStatus1} ${url.split('/')[2]}...`;

            try {
                const response = await fetch(url); 

                if (!response.ok || !response.body) {
                     throw new Error(`HTTP error! Status: ${response.status || 'N/A'}`);
                }

                const reader = response.body.getReader();

                while(true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    receivedLength += value.length;
                    const currentTime = performance.now();
                    const timeElapsed = currentTime - startOverall;

                    const speedMbps = ((receivedLength * 8) / (timeElapsed / 1000)) / 1000000;

                    const percentage = Math.min(100, Math.round((receivedLength / totalLength) * 100));

                    barElement.style.width = `${percentage}%`;
                    statusElement.innerHTML = `${percentage}% | ${lang.downloadStatus2} ${speedMbps.toFixed(2)} Mbps`;
                }

                const endOverall = performance.now();
                const downloadTime = endOverall - startOverall; 

                if (downloadTime === 0 || receivedLength === 0) {
                    throw new Error('Zero time or zero bytes received after successful fetch.');
                }

                const speedMbps = ((receivedLength * 8) / (downloadTime / 1000)) / 1000000;

                barElement.style.animation = 'none';

                return speedMbps;

            } catch (error) {
                console.error("Download test failed:", error);
                statusElement.innerHTML = `${lang.downloadError} (${error.message})`;
                barElement.style.width = '100%';
                barElement.style.animation = 'none';
                barElement.style.background = '#f87171';
                return null;
            }
        }

        // --- Main Global Speed Test Execution Function (No Changes) ---
        async function runGlobalSpeedTest(){
            const lang = langData[currentLang];
            const btn = document.getElementById("speedTestBtn");
            const buttonText = document.getElementById("buttonText");
            const buttonLoader = document.getElementById("buttonLoader");
            const downloadDisplay = document.getElementById("downloadSpeedDisplay");
            const statusElement = document.getElementById("speedStatus");
            const speedBar = document.getElementById("speedBar");

            let downloadSpeed = null;

            btn.disabled = true;
            buttonText.textContent = lang.buttonTesting;
            buttonLoader.style.display = 'block'; 

            downloadDisplay.textContent = '--';
            downloadDisplay.style.color = 'var(--color-primary)';
            speedBar.style.width = '0%';
            speedBar.style.background = 'none'; 
            speedBar.style.animation = 'none'; 
            statusElement.innerHTML = lang.speedStatusStart;

            downloadSpeed = await downloadSpeedTest();

            if (downloadSpeed !== null) {
                const color = getSpeedColor(downloadSpeed);
                downloadDisplay.textContent = downloadSpeed.toFixed(2);
                downloadDisplay.style.color = color;
                statusElement.innerHTML = `${lang.downloadResult1} ${downloadSpeed.toFixed(2)} Mbps. ${lang.downloadResult2}`;
            } else {
                downloadDisplay.textContent = lang.downloadFail;
                downloadDisplay.style.color = '#f87171';
            }

            btn.disabled = false;
            buttonText.textContent = lang.rerunSpeedBtn;
            buttonLoader.style.display = 'none';
        }

        // --- Main DNS Test Execution Function (FIXED) ---
        document.getElementById("startBtn").onclick = async function(){
          const lang = langData[currentLang];
          const btn = this;
          const tbody = document.querySelector('#dnsTable tbody');
          const bestDiv = document.getElementById("bestDNS");

          btn.disabled = true;
          bestDiv.textContent = '';
          // The colspan is 6 (Priority, Name, IP, Domain, Status, Speed)
          tbody.innerHTML = `<tr><td colspan="6"><div class="loader"></div>${lang.loaderDns}</td></tr>`; 

          await new Promise(r => setTimeout(r, 10)); 

          tbody.innerHTML = '';
          const headers = document.querySelectorAll('#dnsTable thead th');

          let rows = dnsServers.map(dns=>{
            const tr = document.createElement('tr');
            // Getting header texts for mobile data-label
            const headerLabels = Array.from(headers).map(th => langData[currentLang][th.getAttribute('data-i18n')]);

            // Format IPs for display (e.g., "8.8.8.8, 8.8.4.4") and for copying
            const ipString = dns.ips.join(', ');
            const ipDisplayHtml = dns.ips.map(ip => `<span class="single-ip">${ip}</span>`).join('');

            tr.innerHTML = `
              <td data-label="${headerLabels[0]}">-</td>
              <td data-label="${headerLabels[1]}">${dns.name}</td>
              <td data-label="${headerLabels[2]}">
                <div class="dns-ip-cell-content">
                    <div class="dns-ips">${ipDisplayHtml}</div>
                    <button class="copy-btn" onclick="copyToClipboard('${ipString}')">${lang.copyDnsBtn}</button>
                </div>
              </td> 
              <td data-label="${headerLabels[3]}">${dns.domain}</td>
              <td data-label="${headerLabels[4]}"><span>${lang.testDnsStatus} (0/${TEST_COUNT})...</span></td>
              <td data-label="${headerLabels[5]}">
                <div class="speed-bar-container"><div class="speed-bar"></div></div>
                <span class="speed-text">0 ms</span>
              </td>
            `;
            tbody.appendChild(tr);
            return {
                dns,
                tr,
                time: MAX_TIMEOUT, 
                // FIXED: Re-checked the selector logic for children. 
                bar:tr.querySelector('.speed-bar'),
                status:tr.children[4].querySelector('span'),
                priorityCell:tr.children[0], 
                speedText:tr.querySelector('.speed-text')
            };
          });

          // Start all test promises
          const testPromises = rows.map(async row=>{
            // Now calling the fixed testDNSProvider which uses all URLs
            row.time = await testDNSProvider(row.dns.urls, row.status); 
            return row;
          });

          Promise.all(testPromises).then(finalRows => {

              finalRows.forEach(row => {
                  const displayTime = Math.round(row.time);

                  const referenceTime = 200; 
                  const barWidth = Math.min(100, (referenceTime / displayTime) * 100); 

                  row.bar.style.width=`${barWidth}%`;
                  row.bar.style.background=getColor(displayTime);

                  row.status.textContent = displayTime>=MAX_TIMEOUT?`‚ùå ${lang.dnsFail}`:`‚úîÔ∏è ${lang.dnsSuccess}`;
                  row.speedText.textContent = displayTime>=MAX_TIMEOUT?`>${MAX_TIMEOUT} ms ${lang.dnsFailedText}`:`${displayTime} ms ${lang.dnsAvg} ${TEST_COUNT})`;
              });

              finalRows.sort((a,b)=>a.time-b.time);

              tbody.innerHTML=''; 
              finalRows.forEach((r,index)=>{ 
                  r.priorityCell.textContent=index+1; 
                  tbody.appendChild(r.tr); 
              });

              const fastestRow = finalRows.find(r=>r.time<MAX_TIMEOUT);
              if(fastestRow){ 
                  fastestRow.tr.classList.add('fastest'); 
                  bestDiv.textContent=`${lang.fastestDns} ${fastestRow.dns.name} (${Math.round(fastestRow.time)} ms)`;
              } else {
                  bestDiv.textContent=lang.allDnsFail;
              }

              btn.disabled=false;
          }).catch(error => {
              console.error("An error occurred during DNS testing:", error);
              bestDiv.textContent=lang.generalError;
              btn.disabled=false;
          });
        };

        // --- Execute code on page load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial call to update DOM with correct language texts for the initial state
            updateDOMText();
            document.getElementById("speedTestBtn").onclick = runGlobalSpeedTest;
        });
    </script>
</body>
</html>


 